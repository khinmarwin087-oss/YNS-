<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MYIN THAR | ONLINE BUSINESS SYSTEM</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ===================  အပိုင်း ၁ - Base Styles / Layout =================== */
        :root { --accent: #FF6B00; --bg: #F5F5F7; --dark: #1D1D1F; --glass: rgba(255,255,255,0.9); }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Montserrat', sans-serif; }
        body { background: var(--bg); color: var(--dark); overflow-x:hidden; }
        .hidden { display:none !important; }

        header { position:fixed; top:0; width:100%; height:70px; background: var(--glass); backdrop-filter:blur(20px); z-index:1000; display:flex; align-items:center; padding:0 20px; justify-content:space-between; border-bottom:1px solid rgba(0,0,0,0.05);}
        #storefront { padding: 90px 15px 150px; }
        .item-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:15px; }
        .item-card { background:white; border-radius:20px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,0.05); position:relative; }
        .preorder-badge { position:absolute; top:10px; left:10px; background:var(--accent); color:white; padding:4px 10px; border-radius:10px; font-size:0.6rem; font-weight:700; }
        .item-img { width:100%; height:140px; object-fit:cover; }
        .qty-btns { display:flex; align-items:center; justify-content:space-between; background:#F2F2F7; border-radius:12px; padding:5px; margin-top:10px; }
        .qty-btn { border:none; background:white; width:30px; height:30px; border-radius:8px; font-weight:bold; cursor:pointer; }

        #sticky-cart {
            position:fixed; bottom:25px; left:50%; transform:translateX(-50%); width:92%; max-width:450px;
            background: var(--dark); color:white; padding:20px 25px; border-radius:25px;
            display:flex; justify-content:space-between; align-items:center; z-index:2000; box-shadow:0 15px 40px rgba(0,0,0,0.4);
        }

        .drawer { position:fixed; bottom:0; left:0; right:0; background:white; border-radius:30px 30px 0 0; padding:30px 20px; z-index:3001; transform:translateY(100%); transition:0.5s cubic-bezier(0.4,0,0.2,1); max-height:90vh; overflow-y:auto;}
        .drawer.active { transform:translateY(0); }
        .overlay { position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:3000; display:none; backdrop-filter:blur(5px); }
    </style>
</head>
<body>

    <!-- ===================  အပိုင်း ၂ - Landing Hero =================== -->
    <div id="landing-hero">
        <div style="font-weight:700; font-size:1.2rem; letter-spacing:5px; margin-bottom:10px;">MYIN THAR</div>
        <h1>အရသာနှင့် ဝန်ဆောင်မှု အကောင်းဆုံး</h1>
        <div class="cta-group">
            <button class="btn-choice btn-today" onclick="entryShop('Today')">ယနေ့မှာယူမည်</button>
            <button class="btn-choice btn-pre" onclick="entryShop('Pre-order')">နောက်နေ့အတွက်မှာမည်</button>
        </div>
        <p onclick="openAdmin()" style="margin-top:50px; opacity:0.3; font-size:0.7rem;">ADMIN ACCESS</p>
    </div>

    <!-- ===================  အပိုင်း ၃ - Storefront =================== -->
    <div id="store-main" class="hidden">
        <header>
            <div onclick="location.reload()"><i class="fas fa-home"></i></div>
            <b id="shop-title">STORE</b>
            <div onclick="openProfile()"><i class="fas fa-user-circle" style="font-size:1.5rem;"></i></div>
        </header>

        <div id="storefront">
            <div id="item-list" class="item-grid"></div>
        </div>

        <div id="sticky-cart" class="hidden" onclick="showCheckout()">
            <div><span id="cart-count">0</span> Items | <span id="cart-total">0</span> Ks</div>
            <div style="font-weight:700;">CHECKOUT <i class="fas fa-arrow-right" style="margin-left:8px;"></i></div>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="closeDrawer()"></div>
    <div class="drawer" id="main-drawer">
        <div id="drawer-content"></div>
    </div>

    <!-- ===================  အပိုင်း ၄ - JavaScript Logic =================== -->
    <script>
        const SB_URL = 'https://deabtvqzxpkepgcdutzd.supabase.co';
const SB_KEY = 'sb_publishable_1oVmjwUas1mPm6Yk6evKvw_RU3MBvXc';
const _supabase = window.supabase.createClient(SB_URL, SB_KEY);

        let cart = {};
        let currentMode = 'Today';
        let itemsData = [];
        let currentCustomerId = null;

        /* ===================  အပိုင်း ၄.၁ - Entry & Load Items =================== */
        async function entryShop(mode) {
            currentMode = mode;
            document.getElementById('landing-hero').classList.add('hidden');
            document.getElementById('store-main').classList.remove('hidden');
            document.getElementById('shop-title').innerText = mode === 'Today' ? "ယနေ့မီနူး" : "PRE-ORDER မီနူး";
            
            const { data } = await _supabase.from('menu_items').select('*').order('id');
            itemsData = data;
            renderItems();
            restoreCart();
        }

        function renderItems() {
            const list = document.getElementById('item-list');
            list.innerHTML = itemsData.map(item => `
                <div class="item-card">
                    ${currentMode==='Pre-order'?'<div class="preorder-badge">PRE-ORDER</div>':''}
                    <img src="${item.photo_url||'https://via.placeholder.com/200x140?text=MyinThar'}" class="item-img">
                    <div style="padding:15px;">
                        <b style="font-size:0.85rem; display:block; height:35px;">${item.name}</b>
                        <div style="color:var(--accent); font-weight:700; margin-top:5px;">${item.price} Ks</div>
                        <div class="qty-btns">
                            <button class="qty-btn" onclick="updateQty('${item.name}', -1)">-</button>
                            <span id="qty-${item.name.replace(/\s/g,'')}" style="font-weight:700;">0</span>
                            <button class="qty-btn" onclick="updateQty('${item.name}', 1)">+</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        /* ===================  အပိုင်း ၄.၂ - Cart Logic =================== */
        function updateQty(name, delta) {
            cart[name] = (cart[name]||0)+delta;
            if(cart[name]<=0) delete cart[name];
            const el=document.getElementById(`qty-${name.replace(/\s/g,'')}`);
            if(el) el.innerText=cart[name]||0;
            saveCart(); updateBar();
        }

        function updateBar() {
            const count=Object.values(cart).reduce((a,b)=>a+b,0);
            const total=Object.keys(cart).reduce((s,n)=>s+(itemsData.find(i=>i.name===n).price*cart[n]),0);
            const bar=document.getElementById('sticky-cart');
            if(count>0){ bar.classList.remove('hidden'); document.getElementById('cart-count').innerText=count; document.getElementById('cart-total').innerText=total; }
            else bar.classList.add('hidden');
        }

        function saveCart(){ localStorage.setItem('mt_cart', JSON.stringify(cart)); }
        function restoreCart(){
            const saved=localStorage.getItem('mt_cart');
            if(saved){ cart=JSON.parse(saved); Object.keys(cart).forEach(name=>{ const el=document.getElementById(`qty-${name.replace(/\s/g,'')}`); if(el) el.innerText=cart[name]; }); updateBar(); }
        }

        /* ===================  အပိုင်း ၄.၃ - Checkout Drawer =================== */
        function showCheckout() {
            const drawer = document.getElementById('main-drawer');
            const content = document.getElementById('drawer-content');
            document.getElementById('overlay').style.display='block';
            drawer.classList.add('active');

            content.innerHTML=`
                <h3>အော်ဒါအနှစ်ချုပ်</h3>
                <div style="margin:20px 0; border-bottom:1px solid #eee; padding-bottom:15px;">
                    ${Object.keys(cart).map(n=>`<div style="display:flex; justify-content:space-between; margin-bottom:8px;"><span>${n} x ${cart[n]}</span><b>${itemsData.find(i=>i.name===n).price*cart[n]} Ks</b></div>`).join('')}
                    <div style="display:flex; justify-content:space-between; margin-top:15px; font-weight:700; font-size:1.2rem; color:var(--accent);"><span>စုစုပေါင်း</span><span>${document.getElementById('cart-total').innerText} Ks</span></div>
                </div>
                <button class="btn-choice btn-today" style="width:100%;" onclick="placeOrder()"><i class="fas fa-check-circle"></i> PLACE ORDER</button>
            `;
        }

        function closeDrawer() { document.getElementById('overlay').style.display='none'; document.getElementById('main-drawer').classList.remove('active'); }

        /* ===================  အပိုင်း ၄.၄ - Place Order Function =================== */
        async function placeOrder(){
            if(Object.keys(cart).length===0){ alert("အော်ဒါမှာထားမှုမရှိသေးပါ"); return; }
            let phone=prompt("အော်ဒါအတွက်ဖုန်းနံပါတ်ထည့်ပါ:");
            if(!phone) return alert("ဖုန်းနံပါတ်လိုအပ်သည်");

            let { data: customer } = await _supabase.from('customers').select('*').eq('phone_number', phone).single();

            if(!customer){
                const { data:newCustomer, error:createErr } = await _supabase.from('customers').insert([{ full_name:"အမည်မသိ", phone_number:phone }]).select().single();
                if(createErr) return alert("Customer create error: "+createErr.message);
                customer=newCustomer;
            }
            currentCustomerId=customer.id;

            const voucherNo="MT"+Date.now();
            let total=0;
            Object.keys(cart).forEach(name=>{ const item=itemsData.find(i=>i.name===name); if(item) total+=item.price*cart[name]; });

            const payment=document.querySelector('input[name="payment"]:checked')?.value||"Cash";

            const { data: orderData, error: orderErr } = await _supabase.from('orders').insert([{
                customer_id: customer.id,
                voucher_no: voucherNo,
                items_json: cart,
                total_amount: total,
                payment_method: payment,
                status:"Pending",
                mode: currentMode
            }]).select().single();

            if(orderErr) return alert("Order save failed: "+orderErr.message);

            cart={}; saveCart(); updateBar(); closeDrawer();
            alert(`အော်ဒါ အောင်မြင်စွာ သိမ်းပြီးပါပြီ။\nVoucher: ${voucherNo}\nTotal: ${total} Ks`);
        }

        /* ===================  အပိုင်း ၄.၅ - Admin Function =================== */
        function openAdmin(){
            const pass=prompt("Admin Password ထည့်ပါ:");
            if(pass==="2012@Yewin"){ alert("Admin Login Success"); }
        }
    </script>
</body>
</html>
