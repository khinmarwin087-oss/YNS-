<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ— á€™á€¼á€„á€ºá€á€¬á€€á€¼á€€á€ºá€€á€„á€º - POS System</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pyidaungsu:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #e67e22; --secondary: #d35400; --bg: #f4f7f6; --dark: #2c3e50; }
        body { font-family: 'Pyidaungsu', sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 500px; margin: auto; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(135deg, #f39c12, #d35400); color: white; padding: 20px; text-align: center; }
        .content { padding: 15px; }
        .input-group { margin-bottom: 12px; }
        label { display: block; font-size: 13px; color: #666; margin-bottom: 5px; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-family: 'Pyidaungsu'; }
        
        .menu-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .menu-item.sold-out { opacity: 0.5; background: #f9f9f9; pointer-events: none; }
        .qty-controls { display: flex; align-items: center; gap: 10px; }
        .btn-qty { width: 32px; height: 32px; border: 1px solid #ddd; background: #fff; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 18px; }
        
        .footer-cart { background: var(--dark); color: white; padding: 20px; text-align: center; position: sticky; bottom: 0; border-radius: 20px 20px 0 0; }
        .btn-main { width: 100%; padding: 15px; background: var(--secondary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.3s; }
        .btn-main:hover { background: #e67e22; }
        .app-selector { background: #fff3e0; padding: 15px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-around; border: 1px solid #ffe0b2; }
        .app-selector label { margin: 0; color: #333; cursor: pointer; font-weight: bold; }
        .sold-text { color: red; font-size: 11px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>ğŸ— á€™á€¼á€„á€ºá€á€¬á€€á€¼á€€á€ºá€€á€„á€º</h2>
        <p>Real-time Stock Management</p>
    </div>

    <div class="content">
        <div class="input-group">
            <label>ğŸ‘¤ á€á€šá€ºá€šá€°á€á€°á€¡á€™á€Šá€º</label>
            <input type="text" id="cust-name" placeholder="á€¡á€™á€Šá€ºá€–á€¼á€Šá€·á€ºá€•á€«">
        </div>
        <div class="input-group">
            <label>ğŸ“ á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€º</label>
            <input type="tel" id="cust-phone" placeholder="á€á‰xxxxxxxxx">
        </div>
        <div class="input-group">
            <label>ğŸ“… á€œá€¬á€šá€°á€™á€Šá€·á€º á€›á€€á€ºá€…á€½á€²á€”á€¾á€„á€·á€º á€¡á€á€»á€­á€”á€º</label>
            <input type="datetime-local" id="pickup-datetime">
        </div>

        <div class="app-selector">
            <label><input type="radio" name="send-via" value="viber" checked> Viber ğŸŸ£</label>
            <label><input type="radio" name="send-via" value="telegram"> Telegram ğŸ”µ</label>
        </div>

        <h3 style="font-size: 16px; color: var(--dark); border-left: 4px solid var(--secondary); padding-left: 10px;">á€…á€¬á€¸á€–á€½á€šá€ºá€™á€®á€”á€°á€¸á€™á€»á€¬á€¸</h3>
        <div id="menu-list">á€™á€®á€”á€°á€¸á€™á€»á€¬á€¸ á€†á€½á€²á€šá€°á€”á€±á€á€Šá€º...</div>
    </div>

    <div class="footer-cart">
        <div style="font-size: 18px; margin-bottom: 12px;">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸: <span id="total-price">0</span> MMK</div>
        <button class="btn-main" onclick="submitOrder()">ğŸš€ á€¡á€±á€¬á€ºá€’á€«á€á€„á€ºá€•á€­á€¯á€·á€™á€Šá€º</button>
    </div>
</div>

<script>
    const SB_URL = "https://ltusknkpwbyriikeyday.supabase.co";
    const SB_KEY = "sb_publishable_u9Y8SIpzqsT4WkyONV4J2w__Xwc09Fv";
    const _supabase = window.supabase.createClient(SB_URL, SB_KEY);
    const MY_PHONE = "959767287345";

    let cart = {};
    let menuData = [];

    // áá‹ Database á€™á€¾ Menu á€€á€­á€¯ Error Handling á€•á€«á€á€„á€ºá€…á€½á€¬ á€†á€½á€²á€‘á€¯á€á€ºá€á€¼á€„á€ºá€¸
    async function fetchMenu() {
        const { data, error } = await _supabase
            .from('menu_items')
            .select('*')
            .order('name');
            
        if (error) {
            console.error('Error:', error);
            document.getElementById('menu-list').innerText = "Data á€†á€½á€²á€šá€°áá€™á€›á€•á€«...";
            return;
        }
        
        if (data) {
            menuData = data;
            renderMenu();
        }
    }

    function renderMenu() {
        const list = document.getElementById('menu-list');
        list.innerHTML = menuData.map(item => {
            const isSoldOut = item.is_sold_out || item.stock_qty <= 0;
            return `
                <div class="menu-item ${isSoldOut ? 'sold-out' : ''}">
                    <div>
                        <b>${item.name}</b><br>
                        <small style="color:#777;">${item.price.toLocaleString()} K (á€œá€€á€ºá€€á€»á€”á€º: ${item.stock_qty})</small>
                        ${isSoldOut ? '<br><span class="sold-text">á€€á€¯á€”á€ºá€á€½á€¬á€¸á€•á€«á€•á€¼á€® (Sold Out)</span>' : ''}
                    </div>
                    <div class="qty-controls">
                        <button class="btn-qty" onclick="updateQty('${item.name}', -1)">-</button>
                        <span id="qty-${item.name}" style="min-width:20px; text-align:center; font-weight:bold;">0</span>
                        <button class="btn-qty" onclick="updateQty('${item.name}', 1)">+</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function updateQty(name, change) {
        const item = menuData.find(i => i.name === name);
        let currentQty = cart[name] || 0;
        let newQty = currentQty + change;

        if (newQty < 0) newQty = 0;
        if (newQty > item.stock_qty) {
            alert("á€œá€€á€ºá€€á€»á€”á€º " + item.stock_qty + " á€á€¯á€á€¬ á€›á€¾á€­á€•á€«á€á€±á€¬á€·á€á€Šá€ºá‹");
            return;
        }

        cart[name] = newQty;
        document.getElementById(`qty-${name}`).innerText = newQty;
        calculateTotal();
    }

    function calculateTotal() {
        let total = 0;
        menuData.forEach(item => {
            if (cart[item.name]) total += cart[item.name] * item.price;
        });
        document.getElementById('total-price').innerText = total.toLocaleString();
    }

    async function submitOrder() {
        const name = document.getElementById('cust-name').value;
        const phone = document.getElementById('cust-phone').value;
        const pickup = document.getElementById('pickup-datetime').value;
        const total = document.getElementById('total-price').innerText;
        const sendVia = document.querySelector('input[name="send-via"]:checked').value;

        if (!name || !phone || !pickup || total === "0") {
            return alert("á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸á€€á€­á€¯ á€•á€¼á€Šá€·á€ºá€…á€¯á€¶á€…á€½á€¬ á€–á€¼á€Šá€·á€ºá€…á€½á€€á€ºá€•á€±á€¸á€•á€«á‹");
        }

        let itemsArr = [];
        // Stock Update Process
        for (let k in cart) {
            if (cart[k] > 0) {
                const item = menuData.find(i => i.name === k);
                itemsArr.push(`${k} (${cart[k]} á€á€¯)`);
                
                // Database á€‘á€²á€™á€¾á€¬ Stock á€”á€¯á€á€ºá€á€¼á€„á€ºá€¸
                const newStock = item.stock_qty - cart[k];
                await _supabase
                    .from('menu_items')
                    .update({ 
                        stock_qty: newStock,
                        is_sold_out: newStock <= 0 
                    })
                    .eq('id', item.id);
            }
        }
        
        const itemsText = itemsArr.join(", ");

        // Orders Table á€‘á€²á€á€­á€¯á€· á€¡á€±á€¬á€ºá€’á€«á€¡á€á€…á€º á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€á€¼á€„á€ºá€¸
        const { data, error: orderErr } = await _supabase.from('orders').insert([{
            customer_name: name, 
            phone: phone, 
            items: itemsText, 
            total: total, 
            pickup_time: pickup
        }]).select();

        if (orderErr) return alert("Order á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸áá€™á€›á€•á€«- " + orderErr.message);

        // App Messaging
        const dateFormatted = new Date(pickup).toLocaleString('my-MM', { dateStyle: 'medium', timeStyle: 'short' });
        const orderMsg = `ğŸ— *á€™á€¼á€„á€ºá€á€¬á€€á€¼á€€á€ºá€€á€„á€º (á€¡á€±á€¬á€ºá€’á€«á€¡á€á€…á€º)*\n` +
                         `--------------------------\n` +
                         `ğŸ†” Order ID: #${data[0].id}\n` +
                         `ğŸ‘¤ á€á€šá€ºá€á€°: ${name}\n` +
                         `ğŸ“ á€–á€¯á€”á€ºá€¸: ${phone}\n` +
                         `ğŸ“… á€œá€¬á€šá€°á€™á€Šá€º: ${dateFormatted}\n` +
                         `ğŸ“¦ á€™á€¾á€¬á€šá€°á€™á€¾á€¯: ${itemsText}\n` +
                         `ğŸ’° á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸: *${total} MMK*\n` +
                         `--------------------------`;

        if (sendVia === 'viber') {
            window.location.href = `viber://contact?number=${MY_PHONE}&draft=${encodeURIComponent(orderMsg)}`;
        } else {
            window.location.href = `https://t.me/+${MY_PHONE}?text=${encodeURIComponent(orderMsg)}`;
        }

        alert("á€¡á€±á€¬á€ºá€’á€«á€…á€¬á€›á€„á€ºá€¸á€€á€­á€¯ App á€‘á€²á€á€½á€„á€º 'Send' á€”á€¾á€­á€•á€ºá€•á€±á€¸á€•á€«á‹");
    }

    window.onload = fetchMenu;
</script>
</body>
</html>

