<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ— á€™á€¼á€„á€ºá€á€¬á€€á€¼á€€á€ºá€€á€„á€º - Ultimate POS</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pyidaungsu:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #fbbf24; --secondary: #ea580c; --bg: #f3f4f6; --white: #ffffff; }
        body { font-family: 'Pyidaungsu', sans-serif; background: var(--bg); margin: 0; padding-bottom: 70px; }
        .hidden { display: none !important; }
        
        /* Voucher Style */
        .voucher-container { background: white; padding: 20px; border-radius: 15px; border: 1px solid #ddd; margin: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center; }
        .v-row { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px; }
        
        /* Layout */
        .card { background: white; margin: 10px; padding: 12px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .food-grid { display: grid; grid-template-columns: 1fr; gap: 5px; padding: 10px; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; max-width: 500px; background: white; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #eee; left: 50%; transform: translateX(-50%); }
        
        .low-stock { color: red; font-weight: bold; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .btn-call { background: #22c55e; color: white; padding: 8px; border-radius: 8px; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-viber { background: #7360f2; color: white; padding: 12px; width: 100%; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

    <audio id="orderSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>
    <audio id="stockAlertSound" src="https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3"></audio>

    <div id="view-home" class="view">
        <div style="padding: 20px; background: var(--secondary); color: white; text-align: center;">
            <h2 style="margin:0;">ğŸ— á€™á€¼á€„á€ºá€á€¬á€€á€¼á€€á€ºá€€á€„á€º</h2>
            <small>á€œá€á€ºá€†á€á€ºá€á€”á€·á€ºá€›á€¾á€„á€ºá€¸á á€¡á€›á€á€¬á€›á€¾á€­á€á€±á€¬ á€¡á€…á€¬á€¸á€¡á€…á€¬á€™á€»á€¬á€¸</small>
        </div>
        <div id="food-list-container" class="food-grid"></div>
    </div>

    <div id="view-voucher" class="view hidden" style="padding: 10px;">
        <div class="voucher-container" id="voucher-content">
            <h3 style="color: var(--secondary);">RECEIPT</h3>
            <p id="v-datetime" style="font-size:12px;"></p>
            <div class="v-row"><span>No:</span> <b id="v-no"></b></div>
            <div class="v-row"><span>ID:</span> <b id="v-id"></b></div>
            <hr>
            <div id="v-items" style="text-align: left; padding: 10px 0;"></div>
            <div class="v-row" style="font-weight:bold; font-size:18px;"><span>á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸:</span> <span id="v-total"></span> K</div>
            <svg id="barcode" style="margin-top:15px;"></svg>
        </div>
        <button class="btn-viber" onclick="sendToAdminViber()">ğŸ“² Viber á€á€­á€¯á€· á€¡á€±á€¬á€ºá€’á€«á€•á€­á€¯á€·á€™á€Šá€º</button>
        <button onclick="showView('home')" style="width:100%; border:none; background:none; color:gray; margin-top:15px;">á€•á€¼á€”á€ºá€á€½á€¬á€¸á€™á€Šá€º</button>
    </div>

    <div id="view-profile" class="view hidden">
        <div class="card" style="text-align: center;">
            <i class="fas fa-user-circle" style="font-size: 50px; color: var(--secondary);"></i>
            <h3 id="p-name">á€§á€Šá€·á€ºá€á€Šá€º</h3>
            <p id="p-phone">-</p>
            <button onclick="editProfile()">Edit Profile</button>
        </div>
        <div class="card">
            <h4>ğŸ“‹ á€™á€¾á€¬á€šá€°á€™á€¾á€¯á€™á€¾á€á€ºá€á€™á€ºá€¸</h4>
            <div id="user-history"></div>
        </div>
    </div>

    <div id="view-admin" class="view hidden" style="padding: 15px;">
        <h3>âš™ï¸ Admin Panel</h3>
        <div class="card">
            <h4>ğŸ“¦ á€•á€…á€¹á€…á€Šá€ºá€¸á€™á€»á€¬á€¸ á€…á€®á€™á€¶á€›á€”á€º (Stock/Price)</h4>
            <div id="admin-inventory-list"></div>
        </div>
        <div class="card">
            <h4>ğŸ“¥ á€¡á€±á€¬á€ºá€’á€«á€¡á€á€…á€ºá€™á€»á€¬á€¸</h4>
            <div id="admin-all-orders"></div>
        </div>
    </div>

    <div class="bottom-nav">
        <div onclick="showView('home')"><i class="fas fa-home"></i><br><small>Home</small></div>
        <div onclick="showView('profile')"><i class="fas fa-user"></i><br><small>Profile</small></div>
        <div onclick="showView('admin-login')"><i class="fas fa-lock"></i><br><small>Admin</small></div>
    </div>

<script>
    const SB_URL = "https://deabtvqzxpkepgcdutzd.supabase.co";
    const SB_KEY = "sb_publishable_1oVmjwUas1mPm6Yk6evKvw_RU3MBvXc";
    const _supabase = window.supabase.createClient(SB_URL, SB_KEY);
    
    let activeOrder = null;

    async function init() {
        const { data: items } = await _supabase.from('menu_items').select('*').order('name');
        renderMenu(items);
        loadProfile();
        setupRealtime();
    }

    function renderMenu(items) {
        document.getElementById('food-list-container').innerHTML = items.map(i => `
            <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; gap:12px; align-items:center;">
                    <img src="${i.photo_url}" style="width:50px; height:50px; border-radius:8px;">
                    <div>
                        <b>${i.name}</b><br>
                        <span style="color:var(--secondary)">${i.price} K</span><br>
                        <small class="${i.stock < 5 ? 'low-stock' : ''}">Stock: ${i.stock}</small>
                    </div>
                </div>
                <button onclick="orderItem(${i.id}, '${i.name}', ${i.price})" ${i.stock <= 0 ? 'disabled' : ''} style="background:var(--secondary); color:white; border:none; padding:8px 15px; border-radius:8px;">
                    ${i.stock <= 0 ? 'Out' : 'á€™á€¾á€¬á€™á€Šá€º'}
                </button>
            </div>
        `).join('');
    }

    async function orderItem(id, name, price) {
        const cName = localStorage.getItem('custName');
        const cPhone = localStorage.getItem('custPhone');
        if(!cName || !cPhone) return editProfile();

        const vNo = "MT-" + Math.floor(10000 + Math.random() * 90000);
        const { data, error } = await _supabase.from('orders').insert([{
            customer_name: cName, phone: cPhone, items: name + " (1)", total: price, status: 'pending', voucher_no: vNo
        }]).select();

        if(!error) {
            await _supabase.rpc('decrement_stock', { row_id: id });
            activeOrder = data[0];
            showVoucher(data[0]);
        }
    }

    function showVoucher(o) {
        showView('voucher');
        document.getElementById('v-datetime').innerText = new Date(o.created_at).toLocaleString();
        document.getElementById('v-no').innerText = o.voucher_no;
        document.getElementById('v-id').innerText = "ID: " + o.id;
        document.getElementById('v-items').innerText = o.items;
        document.getElementById('v-total').innerText = o.total;
        JsBarcode("#barcode", o.voucher_no, { height: 40, displayValue: false });
    }

    function sendToAdminViber() {
        const msg = `ğŸ§¾ á€¡á€±á€¬á€ºá€’á€«á€¡á€á€…á€º\nVoucher: ${activeOrder.voucher_no}\ná€á€šá€ºá€á€°: ${activeOrder.customer_name}\ná€–á€¯á€”á€ºá€¸: ${activeOrder.phone}\ná€•á€…á€¹á€…á€Šá€ºá€¸: ${activeOrder.items}\ná€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸: ${activeOrder.total} K`;
        window.location.href = `viber://forward?text=${encodeURIComponent(msg)}`;
    }

    function showView(v) {
        if(v === 'admin-login') {
            if(prompt("Admin Password?") === "2012@Yewin") { 
                localStorage.setItem('isAdmin', 'true'); v = 'admin'; 
            } else return;
        }
        document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
        document.getElementById('view-' + v).classList.remove('hidden');
        if(v === 'admin') loadAdmin();
        if(v === 'profile') loadUserHistory();
    }

    async function loadAdmin() {
        // Admin: Edit Menu
        const { data: menu } = await _supabase.from('menu_items').select('*').order('name');
        document.getElementById('admin-inventory-list').innerHTML = menu.map(m => `
            <div style="border-bottom:1px solid #eee; padding:10px 0; display:flex; justify-content:space-between;">
                <span>${m.name} (${m.stock})</span>
                <div>
                    <button onclick="editItem(${m.id}, ${m.price}, ${m.stock})">âœï¸ á€•á€¼á€„á€ºá€™á€Šá€º</button>
                </div>
            </div>
        `).join('');

        // Admin: Orders
        const { data: orders } = await _supabase.from('orders').select('*').order('created_at', {ascending: false});
        document.getElementById('admin-all-orders').innerHTML = orders.map(o => `
            <div class="card">
                <b>${o.customer_name}</b> | <a href="tel:${o.phone}">${o.phone}</a><br>
                <small>${o.items}</small> | <b>${o.total} K</b>
            </div>
        `).join('');
    }

    async function editItem(id, p, s) {
        const newPrice = prompt("á€ˆá€±á€¸á€”á€¾á€¯á€”á€ºá€¸á€¡á€á€…á€º?", p);
        const newStock = prompt("Stock á€¡á€á€…á€º?", s);
        if(newPrice && newStock) {
            await _supabase.from('menu_items').update({ price: newPrice, stock: newStock }).eq('id', id);
            loadAdmin();
        }
    }

    function loadProfile() {
        document.getElementById('p-name').innerText = localStorage.getItem('custName') || "á€§á€Šá€·á€ºá€á€Šá€º";
        document.getElementById('p-phone').innerText = localStorage.getItem('custPhone') || "-";
    }

    function editProfile() {
        const n = prompt("á€¡á€™á€Šá€º?"); const p = prompt("á€–á€¯á€”á€ºá€¸?");
        if(n && p) { localStorage.setItem('custName', n); localStorage.setItem('custPhone', p); loadProfile(); }
    }

    async function loadUserHistory() {
        const ph = localStorage.getItem('custPhone');
        const { data } = await _supabase.from('orders').select('*').eq('phone', ph).order('created_at', {ascending: false});
        document.getElementById('user-history').innerHTML = data.map(o => `
            <div style="font-size:13px; border-bottom:1px solid #eee; padding:5px 0;">
                ${new Date(o.created_at).toLocaleDateString()} | ${o.voucher_no}<br>
                ${o.items} - <b>${o.total} K</b> [${o.status}]
            </div>
        `).join('');
    }

    function setupRealtime() {
        _supabase.channel('orders').on('postgres_changes', { event:'INSERT', schema:'public', table:'orders' }, () => {
            document.getElementById('orderSound').play();
            if(localStorage.getItem('isAdmin') === 'true') loadAdmin();
        }).subscribe();
    }

    window.onload = init;
</script>
</body>
</html>

