<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ— á€™á€¼á€„á€ºá€á€¬á€€á€¼á€€á€ºá€€á€„á€º - Business POS</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pyidaungsu:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #e67e22; --secondary: #d35400; --bg: #f4f7f6; --dark: #2c3e50; }
        body { font-family: 'Pyidaungsu', sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 500px; margin: auto; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(135deg, #f39c12, #d35400); color: white; padding: 20px; text-align: center; }
        .content { padding: 15px; }
        .input-group { margin-bottom: 12px; }
        label { display: block; font-size: 13px; color: #666; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-family: 'Pyidaungsu'; font-size: 15px; }
        .menu-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .menu-item.sold-out { opacity: 0.5; background: #f9f9f9; pointer-events: none; }
        .qty-controls { display: flex; align-items: center; gap: 10px; }
        .btn-qty { width: 34px; height: 34px; border: 1px solid #ddd; background: #fff; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 18px; color: var(--secondary); }
        .footer-cart { background: var(--dark); color: white; padding: 20px; text-align: center; position: sticky; bottom: 0; border-radius: 20px 20px 0 0; }
        .btn-main { width: 100%; padding: 15px; background: var(--secondary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 17px; }
        .app-selector { background: #fff3e0; padding: 15px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-around; border: 1px solid #ffe0b2; }
        .app-selector label { margin: 0; cursor: pointer; display: flex; align-items: center; gap: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>ğŸ— á€™á€¼á€„á€ºá€á€¬á€€á€¼á€€á€ºá€€á€„á€º</h2>
        <p>Direct Order POS System</p>
    </div>

    <div class="content">
        <div class="input-group">
            <label>ğŸ‘¤ á€á€šá€ºá€šá€°á€á€°á€¡á€™á€Šá€º</label>
            <input type="text" id="cust-name" placeholder="á€¡á€™á€Šá€ºá€–á€¼á€Šá€·á€ºá€•á€«">
        </div>
        <div class="input-group">
            <label>ğŸ“ á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€º</label>
            <input type="tel" id="cust-phone" placeholder="á€á‰xxxxxxxxx">
        </div>
        <div class="input-group">
            <label>ğŸ“… á€œá€¬á€šá€°á€™á€Šá€·á€º á€›á€€á€ºá€…á€½á€²á€”á€¾á€„á€·á€º á€¡á€á€»á€­á€”á€º</label>
            <input type="datetime-local" id="pickup-datetime">
        </div>

        <div class="app-selector">
            <label><input type="radio" name="send-via" value="viber" checked> Viber Business ğŸŸ£</label>
            <label><input type="radio" name="send-via" value="telegram"> Telegram ğŸ”µ</label>
        </div>

        <h3 style="font-size: 16px; border-left: 4px solid var(--secondary); padding-left: 10px; color: var(--dark);">ğŸ± á€…á€¬á€¸á€–á€½á€šá€ºá€™á€®á€”á€°á€¸á€™á€»á€¬á€¸</h3>
        <div id="menu-list">á€™á€®á€”á€°á€¸á€™á€»á€¬á€¸ á€†á€½á€²á€šá€°á€”á€±á€á€Šá€º...</div>
    </div>

    <div class="footer-cart">
        <div style="font-size: 19px; margin-bottom: 12px; font-weight: bold;">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸: <span id="total-price">0</span> MMK</div>
        <button class="btn-main" onclick="submitOrder()">ğŸš€ á€¡á€±á€¬á€ºá€’á€«á€á€„á€ºá€•á€­á€¯á€·á€™á€Šá€º</button>
    </div>
</div>

<script>
    const SB_URL = "https://deabtvqzxpkepgcdutzd.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRlYWJ0dnF6eHBrZXBnY2R1dHpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzQzNDMsImV4cCI6MjA4MTg1MDM0M30.BbxmM65uoTDcf_nTP6w5siSF6Y5_eM4peqYJCAxR90I";
    const _supabase = window.supabase.createClient(SB_URL, SB_KEY);

    const MY_PHONE = "959767287345"; 
    const VIBER_BUSINESS_URI = "d42829d6-dced-11f0-a2db-36dcc9215546"; 

    let cart = {};
    let menuData = [];

    async function fetchMenu() {
        const { data, error } = await _supabase.from('menu_items').select('*').order('name');
        if (data) {
            menuData = data;
            renderMenu();
        }
    }

    function renderMenu() {
        const list = document.getElementById('menu-list');
        list.innerHTML = menuData.map(item => `
            <div class="menu-item ${item.is_sold_out || item.stock_qty <= 0 ? 'sold-out' : ''}">
                <div>
                    <b style="font-size:15px;">${item.name}</b><br>
                    <small style="color:#666;">${item.price.toLocaleString()} K (á€œá€€á€ºá€€á€»á€”á€º: ${item.stock_qty})</small>
                </div>
                <div class="qty-controls">
                    <button class="btn-qty" onclick="updateQty('${item.name}', -1)">-</button>
                    <span id="qty-${item.name}" style="font-weight:bold; min-width:20px; text-align:center;">0</span>
                    <button class="btn-qty" onclick="updateQty('${item.name}', 1)">+</button>
                </div>
            </div>
        `).join('');
    }

    function updateQty(name, change) {
        const item = menuData.find(i => i.name === name);
        cart[name] = (cart[name] || 0) + change;
        if (cart[name] < 0) cart[name] = 0;
        if (cart[name] > item.stock_qty) cart[name] = item.stock_qty;
        
        document.getElementById(`qty-${name}`).innerText = cart[name];
        calculateTotal();
    }

    function calculateTotal() {
        let total = 0;
        menuData.forEach(i => total += (cart[i.name] || 0) * i.price);
        document.getElementById('total-price').innerText = total.toLocaleString();
    }

    async function submitOrder() {
        const name = document.getElementById('cust-name').value;
        const phone = document.getElementById('cust-phone').value;
        const pickup = document.getElementById('pickup-datetime').value;
        const total = document.getElementById('total-price').innerText;
        const sendVia = document.querySelector('input[name="send-via"]:checked').value;

        if (!name || !phone || !pickup || total === "0") return alert("á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸á€€á€­á€¯ á€•á€¼á€Šá€·á€ºá€…á€¯á€¶á€…á€½á€¬ á€–á€¼á€Šá€·á€ºá€…á€½á€€á€ºá€•á€±á€¸á€•á€«á‹");

        let itemsArr = [];
        for (let k in cart) {
            if (cart[k] > 0) {
                itemsArr.push(`${k} [${cart[k]} á€á€¯]`);
                const item = menuData.find(i => i.name === k);
                await _supabase.from('menu_items').update({ stock_qty: item.stock_qty - cart[k] }).eq('id', item.id);
            }
        }

        // Database á€á€­á€¯á€· á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€á€¼á€„á€ºá€¸
        const { data } = await _supabase.from('orders').insert([{
            customer_name: name, phone: phone, items: itemsArr.join(", "), total: total, pickup_time: pickup
        }]).select();

        const orderId = data[0].id;
        const pickupTime = new Date(pickup).toLocaleString('my-MM', { dateStyle: 'medium', timeStyle: 'short' });

        // á€•á€­á€¯á€™á€­á€¯á€›á€¾á€„á€ºá€¸á€œá€„á€ºá€¸á€á€±á€¬ Message Format
        const msg = `ğŸ— *á€™á€¼á€„á€ºá€á€¬á€€á€¼á€€á€ºá€€á€„á€º (á€¡á€±á€¬á€ºá€’á€«á€¡á€á€…á€º)*\n` +
                    `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
                    `ğŸ†” *Order ID:* #${orderId}\n` +
                    `ğŸ‘¤ *á€á€šá€ºá€á€°:* ${name}\n` +
                    `ğŸ“ *á€–á€¯á€”á€ºá€¸:* ${phone}\n` +
                    `ğŸ“… *á€œá€¬á€šá€°á€™á€Šá€º:* ${pickupTime}\n` +
                    `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
                    `ğŸ“¦ *á€™á€¾á€¬á€šá€°á€á€Šá€·á€ºá€…á€¬á€›á€„á€ºá€¸:*\n` +
                    itemsArr.map(i => "â–ªï¸ " + i).join('\n') + `\n\n` +
                    `ğŸ’° *á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸:* *${total} MMK*\n` +
                    `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`;

        if (sendVia === 'viber') {
            // Viber Business (Public Account) Link
            window.location.href = `viber://pa?chatURI=${VIBER_BUSINESS_URI}&text=${encodeURIComponent(msg)}`;
        } else {
            // Telegram Link
            window.location.href = `https://t.me/+${MY_PHONE}?text=${encodeURIComponent(msg)}`;
        }
    }

    window.onload = fetchMenu;
</script>
</body>
</html>

